#
# $Id: Makefile.in,v 1.23 2001/02/22 08:37:58 kunishi Exp $
#

include version.mk

PATH=		/bin:/usr/bin:/usr/ccs/bin:/opt/sfw/bin:/usr/sbin:${TMPBINDIR}${EXTRA_PATH}

PKGNAME=	soap

LOCALBASE=	@soap_topdir@
SOAP_DIR=	${LOCALBASE}

CWD:sh=		pwd
BOOTSTRAPDIR=	${CWD}/bootstrap
CONTRIBDIR=	${CWD}/contrib
DISTDIR=	${CWD}/distfiles
MAKEFILEDIR=	${CWD}/mk
PKGDIR=		${CWD}/pkg
PORTSDIR=	${CWD}/ports
RELEASEDIR=	${CWD}/release
TOOLSDIR=	${CWD}/tools
WRKDIR=		${CWD}/work
TMPPREFIX=	${WRKDIR}${LOCALBASE}
TMPBINDIR=	${TMPPREFIX}/bin

COMPRESS=	compress
CP=		cp
ENV=		env
LN=		ln
MKDIR=		mkdir -p
RM=		rm
SED=		sed
SH=		/bin/sh
TAR=		tar
GZIP_CMD=	gzip
CC?=		gcc
GMAKE?=		gmake	# defined in sunos.${OSREL}.mk

BMAKE=		bmake
LNDIR=		${TOOLSDIR}/lndir.sh

PKGMK=		pkgmk -o
PKGTRANS=	pkgtrans -o
PKGINFO=	pkginfo -q

ARCH:sh=	/usr/bin/mach
OSREL:sh=	/usr/bin/uname -r

RELEASE_PKG_DIR=	${RELEASEDIR}/${ARCH}/${OSREL}
RELEASE_DATE:sh=	/usr/bin/date +%Y%m%d
RELEASE_TIME:sh=	/usr/bin/date +%Y.%m.%d.%H.%M
RELEASE_HOST:sh=	/usr/bin/hostname

SOAP_MKS=		${BOOTSTRAPDIR}/soap.conf \
			${BOOTSTRAPDIR}/port.mk \
			${BOOTSTRAPDIR}/port.pre.mk
SOAP_PSTAMP=		${RELEASE_HOST}:${RELEASE_TIME}
SOAP_CONF_PKG=		${PKGNAME}-conf-${SOAP_VERSION}-${SOAP_REV}

BOOTSTRAP_ENV=	TOPDIR=${CWD} \
		PATH=${PATH} \
		LOCALBASE=${LOCALBASE} \
		GMAKE=${GMAKE} \
		CC=${CC}

MAKE_ENV=	${BOOTSTRAP_ENV}

#BOOTSTRAP_FLAGS=${MAKEFLAGS} \
#		PREFIX=${TMPPREFIX} \
#		prefix=${TMPPREFIX}

#MAKEFLAGS=	TOPDIR=${CWD} \
#		PATH=${PATH} \
#		LOCALBASE=${LOCALBASE} \
#		GMAKE=${GMAKE} \
#		BOOTSTRAPDIR=${BOOTSTRAPDIR}

include sunos.${OSREL}.mk

DIST_PKGS?=	# none
BOOTSTRAP_TOOLS?=	make texinfo gperf patch
BUILD_PKGS_GNU?=	make gcc gperf tar gzip patch texinfo
BUILD_PKGS_BSD?=	lukemftp bmake md5
BUILD_PKGS=	${BUILD_PKGS_GNU} ${BUILD_PKGS_BSD}

BUILD_PACKAGE_OPTS=	SOAP_SRCDIR=${CWD} \
			SOAP_DIR=${SOAP_DIR} \
			SOAP_BINDIR=${WRKDIR}${LOCALBASE}/bin \
			RELEASE_PKG_DIR=${RELEASEDIR} \
			CORE_TOOLS=yes 

all:
	@echo "Start build process under PATH=${PATH}"
	${MAKE} check-required-packages
	${MAKE} prepare-build-tree
#	${MAKE} bootstrap-tools
	${MAKE} build-tools

check-required-packages::
	@if [ "${DIST_PKGS}" != "" ]; then \
	  for pkg in "${DIST_PKGS}"; do \
	    if [ `${PKGINFO} $$pkg` ]; then \
	      echo "Solaris package $$pkg is required."; \
	      echo "Install the package $$pkg before building this software."; \
	      exit 1; \
	    fi; \
	  done; \
	fi

prepare-build-tree::
	@${RM} -rf ${WRKDIR}
	@${MKDIR} ${WRKDIR}
	@${MKDIR} ${WRKDIR}${LOCALBASE}
	@for pkg in ${BUILD_PKGS_GNU}; do \
	  ${MKDIR} ${WRKDIR}/$$pkg; \
	  cd ${WRKDIR}/$$pkg; \
	  ${LNDIR} ${CONTRIBDIR}/gnu/$$pkg; \
	done
	@for pkg in ${BUILD_PKGS_BSD}; do \
	  ${MKDIR} ${WRKDIR}/$$pkg; \
	  cd ${WRKDIR}/$$pkg; \
	  ${LNDIR} ${CONTRIBDIR}/bsd/$$pkg; \
	done

bootstrap-tools::
	for pkg in ${BOOTSTRAP_TOOLS}; do \
	  cd ${BOOTSTRAPDIR}/$$pkg && ${ENV} ${BOOTSTRAP_ENV} ${MAKE} ${BOOTSTRAP_FLAGS} install; \
	done

build-tools::
	@for pkg in ${BUILD_PKGS}; do \
	  cd ${BOOTSTRAPDIR}/$$pkg && ${MAKE_ENV} ${MAKE} ${MAKEFLAGS} install; \
	done

prepare-for-package::
	cd ${TOPDIR} && \
	  (${RM} -f bin && ${LN} -s ${WRKDIR}${LOCALBASE}/bin)
	${MKDIR} ${RELEASE_PKG_DIR}
	${CP} ${SOAP_MKS} ${WRKDIR}${LOCALBASE}/share/mk

build-package::
	for tool in ${CORE_TOOLS}; do \
	  (cd ${PORTSDIR}/$${tool} && \
	     ${ENV} PATH=${PATH} ${BMAKE} ${BUILD_PACKAGE_OPTS} package); \
	done
	for tool in ${CORE_TOOLS}; do \
	  (cd ${PORTSDIR}/$${tool} && \
	     ${ENV} PATH=${PATH} ${BMAKE} ${BUILD_OPTS} release); \
	done

build-misc-package::
	${MKDIR} ${WRKDIR}/spool
	${SED} -e 's!%%INSTPREFIX%%!${CWD}!' \
	       ${PKGDIR}/prototype.in > ${PKGDIR}/prototype
	${SED}	-e 's!%%SOAP_DIR%%!${SOAP_DIR}!' \
	      	-e 's!%%SOAP_VERSION%%!${SOAP_VERSION}!' \
		-e 's!%%SOAP_PSTAMP%%!${SOAP_PSTAMP}!' \
	       ${PKGDIR}/pkginfo.in > ${PKGDIR}/pkginfo
	${PKGMK} -d ${WRKDIR}/spool -f ${PKGDIR}/prototype
	${PKGTRANS} -s ${WRKDIR}/spool ${RELEASE_PKG_DIR}/${SOAP_CONF_PKG} all
	${GZIP_CMD} ${RELEASE_PKG_DIR}/${SOAP_CONF_PKG}

clean::
	@for pkg in ${BUILD_PKGS}; do \
	  cd ${BOOTSTRAPDIR}/$$pkg && ${MAKE_ENV} ${MAKE} ${MAKEFLAGS} clean; \
	done

releaseclean:
	${RM} -rf ${RELEASEDIR}

distclean:
	${RM} -f Makefile
	${RM} -rf ${RELEASEDIR}
#	${RM} -f ${DISTDIR}/*.tar ${DISTDIR}/*.tar.gz ${DISTDIR}/*.tar.Z
