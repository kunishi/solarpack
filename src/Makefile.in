#
# $Id: Makefile.in,v 1.12 2000/05/11 07:42:32 kunishi Exp $
#

PKGNAME=	solpkg-0.1

LOCALBASE=	/usr/local
SOLPKGDIR=	@solpkg_topdir@

CWD:sh=		pwd
BOOTSTRAPDIR=	${CWD}/bootstrap
DISTDIR=	${CWD}/distfiles
MAKEFILEDIR=	${CWD}/mk
PKGDIR=		${CWD}/pkg
PORTSDIR=	${CWD}/ports
RELEASEDIR=	${CWD}/release
WRKDIR=		${CWD}/work

COMPRESS=	/usr/bin/compress
CP=		/usr/bin/cp
ENV=		/usr/bin/env
PKGMK=		/usr/bin/pkgmk
PKGTRANS=	/usr/bin/pkgtrans
LN=		/usr/bin/ln
MKDIR=		/usr/bin/mkdir -p
PKGMK=		/usr/bin/pkgmk -o
PKGTRANS=	/usr/bin/pkgtrans -o
RM=		/usr/bin/rm
SED=		/usr/bin/sed
SH=		/bin/sh
TAR=		/usr/bin/tar

BMAKE=		${CWD}/bin/bmake

ARCH:sh=	/usr/bin/mach
OSREL:sh=	/usr/bin/uname -r

STANDARD_PATH=	/bin:/usr/bin:/usr/ccs/bin:/usr/sbin:/usr/ucb

RELEASE_PKG_DIR=	${RELEASEDIR}/${ARCH}/${OSREL}
RELEASE_DATE:sh=	/usr/bin/date +%G%m%d
WORKDIR=	${CWD}/work

MAKEFLAGS=	TOPDIR=${CWD}

CORE_TOOLS=	\
		bmake \
		gcc \
		gmake \
		gtar \
		gzip \
		lukemftp \
		md5 \
		patch \
		texinfo

BUILD_PACKAGE_OPTS=	SOLPKGSRCDIR=${CWD} \
			SOLPKGDIR=${SOLPKGDIR} \
			RELEASE_PKG_DIR=${RELEASEDIR} \
			CORE_TOOLS=yes 

all:
	${MAKE} bootstrap

bootstrap::
	${MAKE} build-strap-tools
	${MAKE} prepare-for-package
	${MAKE}	build-package
	${MAKE} build-misc-package

build-strap-tools::
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.gzip install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.lukemftp install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.gcc install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.gmake install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.patch install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.bmake install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.gtar install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.md5 install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.texinfo install

prepare-for-package::
	cd ${TOPDIR} && \
	  (${RM} -f bin && ${LN} -s ${WRKDIR}/usr/local/bin)
	${MKDIR} ${RELEASE_PKG_DIR}
	${CP} ${BOOTSTRAPDIR}/solpkg.conf ${BOOTSTRAPDIR}/port.mk \
	  ${WRKDIR}/usr/local/share/mk

build-package::
	for tool in ${CORE_TOOLS}; do \
	  (PATH=${WRKDIR}/usr/local/bin:${STANDARD_PATH}; export PATH; \
	   cd ${PORTSDIR}/$${tool} && \
	     ${BMAKE} ${BUILD_PACKAGE_OPTS} release); \
	done

build-misc-package::
	${MKDIR} ${WRKDIR}/spool
	${SED} -e 's!%%INSTPREFIX%%!${CWD}!' ${PKGDIR}/prototype.in > ${PKGDIR}/prototype
	${PKGMK} -d ${WRKDIR}/spool -f ${PKGDIR}/prototype
	${PKGTRANS} -s ${WRKDIR}/spool ${RELEASE_PKG_DIR}/solpkg-misc-0.1 all
	${CWD}/bin/gzip ${RELEASE_PKG_DIR}/solpkg-misc-0.1

clean:
	${RM} -rf config.cache config.log config.status
	${RM} -f ${PKGDIR}/pkginfo ${PKGDIR}/prototype
	cd mk && ${MAKE} clean
	for tool in ${CORE_TOOLS}; do \
	  (cd ${PORTSDIR}/$${tool} && ${BMAKE} ${BUILD_PACKAGE_OPTS} pkgclean); \
	done
	${RM} -rf ${WRKDIR}
	${RM} ${CWD}/bin

releaseclean:	clean
	${RM} -rf ${RELEASEDIR}

distclean:	releaseclean
	${RM} -f Makefile
	${RM} -rf ${RELEASEDIR}
	${RM} ${DISTDIR}/*.tar ${DISTDIR}/*.tar.gz ${DISTDIR}/*.tar.Z
