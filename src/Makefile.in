#
# $Id: Makefile.in,v 1.21 2000/05/17 05:41:47 kunishi Exp $
#

include version.mk
PKGNAME=	soap

LOCALBASE=	/usr/local
SOAP_DIR=	@soap_topdir@

CWD:sh=		pwd
BOOTSTRAPDIR=	${CWD}/bootstrap
DISTDIR=	${CWD}/distfiles
MAKEFILEDIR=	${CWD}/mk
PKGDIR=		${CWD}/pkg
PORTSDIR=	${CWD}/ports
RELEASEDIR=	${CWD}/release
WRKDIR=		${CWD}/work

COMPRESS=	/usr/bin/compress
CP=		/usr/bin/cp
ENV=		/usr/bin/env
PKGMK=		/usr/bin/pkgmk
PKGTRANS=	/usr/bin/pkgtrans
LN=		/usr/bin/ln
MKDIR=		/usr/bin/mkdir -p
PKGMK=		/usr/bin/pkgmk -o
PKGTRANS=	/usr/bin/pkgtrans -o
RM=		/usr/bin/rm
SED=		/usr/bin/sed
SH=		/bin/sh
TAR=		/usr/bin/tar

BMAKE=		${CWD}/bin/bmake

ARCH:sh=	/usr/bin/mach
OSREL:sh=	/usr/bin/uname -r

STANDARD_PATH=	/bin:/usr/bin:/usr/ccs/bin:/usr/sbin

RELEASE_PKG_DIR=	${RELEASEDIR}/${ARCH}/${OSREL}
RELEASE_DATE:sh=	/usr/bin/date +%Y%m%d
RELEASE_TIME:sh=	/usr/bin/date +%Y.%m.%d.%H.%M
RELEASE_HOST:sh=	/usr/bin/hostname

SOAP_PSTAMP=		${RELEASE_HOST}:${RELEASE_TIME}
SOAP_CONF_PKG=		${PKGNAME}-conf-${SOAP_VERSION}-${SOAP_REV}

MAKEFLAGS=	TOPDIR=${CWD} \
		BOOTSTRAPDIR=${BOOTSTRAPDIR}

CORE_TOOLS=	bmake gcc gmake gtar gzip lukemftp md5 patch texinfo

BUILD_OPTS=		SOAP_SRCDIR=${CWD} \
			SOAP_DIR=${SOAP_DIR} \
			SOAP_BINDIR=${WRKDIR}${LOCALBASE}/bin \
			RELEASE_PKG_DIR=${RELEASEDIR} \
			CORE_TOOLS=yes 

BUILD_PACKAGE_OPTS=	SOAP_SRCDIR=${CWD} \
			SOAP_DIR=${SOAP_DIR} \
			SOAP_BINDIR=${WRKDIR}${LOCALBASE}/bin \
			RELEASE_PKG_DIR=${RELEASEDIR} \
			CORE_TOOLS=yes 

all:
	${MAKE} bootstrap

bootstrap::
	${MAKE} build-strap-tools
	${MAKE} prepare-for-package
	${MAKE} build-tools
	${MAKE}	build-package
	${MAKE} build-misc-package

build-strap-tools::
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.gzip install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.lukemftp install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.gcc install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.gmake install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.patch install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.bmake install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.gtar install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.md5 install
	${MAKE} ${MAKEFLAGS} -f ${BOOTSTRAPDIR}/Makefile.texinfo install

prepare-for-package::
	cd ${TOPDIR} && \
	  (${RM} -f bin && ${LN} -s ${WRKDIR}${LOCALBASE}/bin)
	${MKDIR} ${RELEASE_PKG_DIR}
	${CP} ${BOOTSTRAPDIR}/soap.conf ${BOOTSTRAPDIR}/port.mk \
	  ${WRKDIR}${LOCALBASE}/share/mk

build-tools::
	for tool in ${CORE_TOOLS}; do \
	  (PATH=${WRKDIR}${LOCALBASE}/bin:${STANDARD_PATH}; export PATH; \
	   cd ${PORTSDIR}/$${tool} && \
	     ${BMAKE} ${BUILD_OPTS} install); \
	done

build-package::
	for tool in ${CORE_TOOLS}; do \
	  (PATH=${WRKDIR}${LOCALBASE}/bin:${STANDARD_PATH}; export PATH; \
	   cd ${PORTSDIR}/$${tool} && \
	     ${BMAKE} ${BUILD_PACKAGE_OPTS} package); \
	done
	for tool in ${CORE_TOOLS}; do \
	  (PATH=${WRKDIR}${LOCALBASE}/bin:${STANDARD_PATH}; export PATH; \
	   cd ${PORTSDIR}/$${tool} && \
	     ${BMAKE} ${BUILD_OPTS} release); \
	done


build-misc-package::
	${MKDIR} ${WRKDIR}/spool
	${SED} -e 's!%%INSTPREFIX%%!${CWD}!' \
	       ${PKGDIR}/prototype.in > ${PKGDIR}/prototype
	${SED}	-e 's!%%SOAP_DIR%%!${SOAP_DIR}!' \
	      	-e 's!%%SOAP_VERSION%%!${SOAP_VERSION}!' \
		-e 's!%%SOAP_PSTAMP%%!${SOAP_PSTAMP}!' \
	       ${PKGDIR}/pkginfo.in > ${PKGDIR}/pkginfo
	${PKGMK} -d ${WRKDIR}/spool -f ${PKGDIR}/prototype
	${PKGTRANS} -s ${WRKDIR}/spool ${RELEASE_PKG_DIR}/${SOAP_CONF_PKG} all
	${CWD}/bin/gzip ${RELEASE_PKG_DIR}/${SOAP_CONF_PKG}

clean:
	${RM} -rf config.cache config.log config.status
	${RM} -f ${PKGDIR}/pkginfo ${PKGDIR}/prototype
	cd mk && ${MAKE} clean
	for tool in ${CORE_TOOLS}; do \
	  (cd ${PORTSDIR}/$${tool} && ${BMAKE} ${BUILD_PACKAGE_OPTS} pkgclean); \
	done
	${RM} -rf ${WRKDIR}
	${RM} ${CWD}/bin

releaseclean:
	${RM} -rf ${RELEASEDIR}

distclean:
	${RM} -f Makefile
	${RM} -rf ${RELEASEDIR}
#	${RM} -f ${DISTDIR}/*.tar ${DISTDIR}/*.tar.gz ${DISTDIR}/*.tar.Z
